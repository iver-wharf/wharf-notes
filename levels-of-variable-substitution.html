<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Levels of variable substitution - Wharf architecture</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Iver" name="author" /><meta content="This is mostly just a brainstorm of the levels of variable substitution complexity in YAML files." name="description" /><meta content="Levels of variable substitution" property="og:title" /><meta content="Wharf architecture" property="og:site_name" /><meta content="article" property="og:type" /><meta content="levels-of-variable-substitution" property="neuron:zettel-id" /><meta content="levels-of-variable-substitution" property="neuron:zettel-slug" /><meta content=".wharf-ci.yml" property="neuron:zettel-tag" /><meta content="root/exploration" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(251,189,8,0.1)}body nav.bottomPane{background-color:rgba(251,189,8,2.0e-2)}body div#footnotes{border-top-color:#fbbd08}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#fbbd08;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(251,189,8,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><!-- Mermaid  -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
window.addEventListener("load", mermaid.initialize({startOnLoad:true}))
</script>

<!-- Prism.js -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="exploration">exploration/</a></span></span></div></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Levels of variable substitution</h1><p>This is mostly just a brainstorm of the levels of variable substitution complexity in YAML files.</p><p>This could be translated as well over to Kubernetes manifests that are written in YAML, leading to letting YAML be the language of choice in Wharf, or if we expand to allow other object notations as well such as JSON, SEN, XML, etc.</p><!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<h2 id="table-of-contents">Table of contents</h2><ul><li><a href="#levels-of-variable-substitution">Levels of variable substitution</a><ul><li><a href="#0-current">0. Current</a></li><li><a href="#1-keeping-the-basic-types">1. Keeping the basic types</a></li><li><a href="#2-keeping-even-lists">2. Keeping even lists</a></li><li><a href="#3-full-dynamic-ast-traversal">3. Full dynamic AST traversal</a></li><li><a href="#4-recursive-dynamic-ast-traversal">4. Recursive dynamic AST traversal</a></li><li><a href="#5-recursive-variable-lookup">5. Recursive variable lookup</a></li></ul></li></ul><!-- markdown-toc end -->
<h2 id="0-current">0. Current</h2><p>This is how our variable substitution in our Jenkinsfile works currently.</p><p>It sort of resembles variable substitution in scripting languages such as <code>sh</code> or <code>bash</code>, as they only support strings and force all values into strings at all times. It’s very unflexible and very common cause of headaches.</p><p>Wharf sufferes kind of the same symphtoms in users, as the border of where the features stop seems arbitrary and lackluster.</p><pre><code class="yaml language-yaml">environments:
  myEnv:
    myBool: true
    myString: &quot;true&quot;

myStage:
  environments: [myEnv]
  myStep1:
    docker:
      push: true
  myStep2:
    docker:
      push: ${myBool}
  myStep3:
    docker:
      push: ${myString}</code></pre><p>Resolves to:</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep1:
    docker:
      push: true
  myStep2:
    docker:
      push: &quot;true&quot;
  myStep3:
    docker:
      push: &quot;true&quot;

# And then the Groovy code in the Jenkinsfile parses it again when reading the
# property, meaning we could probably even allow values such as `1` or `&quot;on&quot;`</code></pre><h2 id="1-keeping-the-basic-types">1. Keeping the basic types</h2><pre><code class="yaml language-yaml">environments:
  myEnv:
    myBool: true
    myString: &quot;true&quot;

myStage:
  environments: [myEnv]
  myStep1:
    docker:
      push: true
  myStep2:
    docker:
      push: ${myBool}
  myStep3:
    docker:
      push: ${myString}</code></pre><p>Resolves to:</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep1:
    docker:
      push: true
  myStep2:
    docker:
      push: true
  myStep3:
    docker:
      # Here we could throw because the variable is not a boolean
      push: &quot;true&quot;</code></pre><h2 id="2-keeping-even-lists">2. Keeping even lists</h2><pre><code class="yaml language-yaml">environments:
  myEnv:
    myCmds:
      - a
      - b
      - c

myStage:
  environments: [myEnv]
  myStep1:
    container:
      cmds:
        - foo
        - bar
  myStep2:
    container:
      cmds: ${myCmds}
  myStep3:
    container:
      # What do we do here?
      # a: throw an error
      # b: try to deal with it
      cmds: &quot;${myCmds} heyo&quot;</code></pre><p>Resolves to:</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep1:
    container:
      cmds:
        - foo
        - bar
  myStep2:
    container:
      cmds:
        - a
        - b
        - c
  myStep3:
    container:
      # If we &quot;b: try to deal with it&quot;, how would that look?
      cmds: &quot;[a, b, c] heyo&quot;
      cmds:
        - a
        - b
        - c heyo
      cmds:
        - a
        - b
        - c
        - heyo
      cmds:
        - a heyo
        - b heyo
        - c heyo</code></pre><h2 id="3-full-dynamic-ast-traversal">3. Full dynamic AST traversal</h2><p>This could more or less only be accomplished by storing the entire abstract syntax tree (AST) of the YAML in memory, and as we traverse it we will substitute variables appropriately.</p><p>This resembles more how scripting languages such as PowerShell works.</p><pre><code class="yaml language-yaml">environments:
  myEnv:
    myContainer:
      image: ubuntu:20.04
      cmds:
        - echo foo
        - sleep 5s
        - echo bar
    myStep:
      docker:
        push: true

myStage:
  environments: [myEnv]
  myStep1:
    container:
      cmds:
        - foo
        - bar

  myStep2:
    container: ${myContainer}

  myStep3:
    # Difficult to come up with a good way this should be interpreted as.
    # Best solution should probably just be to throw here, but for consistency
    # then the above example should also throw on its weird list thing
    container: &quot;${myContainer} heyo&quot;
    
  myStep4: ${myStep}</code></pre><p>Resolves to:</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep1:
    container:
      cmds:
        - foo
        - bar
  myStep2:
    container:
      image: ubuntu:20.04
      cmds:
        - echo foo
        - sleep 5s
        - echo bar
        
  # `myStep3` omitted for demo purposes because it would throw an error
  
  myStep4:
    docker:
      push: true</code></pre><h2 id="4-recursive-dynamic-ast-traversal">4. Recursive dynamic AST traversal</h2><p>To allow variables to reference each other, this can get messy quickly. We would have to be able to detect recursion loops for this to be viable.</p><pre><code class="yaml language-yaml">inputs:
  myImage:
    type: string
    default: ubuntu:20.04

environments:
  myEnv:
    myContainer:
      image: ${myImage}
      cmds: ${myCmds}
    myCmds:
      - a
      - b
      - c

myStage:
  environments: [myEnv]
  myStep:
    container: ${myContainer}</code></pre><p>Resolves to:</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep:
    container:
      # Given that the input was not changed from its default value.
      image: ubuntu:20.04
      cmds:
        - a
        - b
        - c</code></pre><h2 id="5-recursive-variable-lookup">5. Recursive variable lookup</h2><p>Here we enter the land of <em>“Yo wtf!”</em></p><p>This would require recursive traversal on even the variable lookups.</p><blockquote><p>Would this even be useful? Some might like it, but it will probably just be confusing to read.</p></blockquote><pre><code class="yaml language-yaml">inputs:
  myStepSelection:
    type: enum
    default: 
    values:
      - Container
      - Docker

environments:
  myEnv:
    myDocker:
      docker:
        image: ubuntu:20.04
    myContainer:
      container:
        image: ubuntu:20.04
        cmds: ${myCmds}
    myCmds:
      - a
      - b
      - c
    mySteps:
      - myDocker
      - myContainer

myStage:
  environments: [myEnv]
  # Select the variable based on another variable
  # Either resolves to
  #   if ${myStepSelection}=&quot;Container&quot; -&gt; ${myContainer}
  #   if ${myStepSelection}=&quot;Docker&quot; -&gt; ${myDocker}
  myStep: ${my${myStepSelection}}

myMatrixStage:
  # No clue how we would resolve lists, but this might be the technique
  step_${mySteps}: ${${mySteps}}</code></pre><p>Resolves to: (if <code>myStepSelection</code> is set to <code>Container</code>)</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep:
    container:
      image: ubuntu:20.04
      cmds:
        - a
        - b
        - c

myMatrixStage:
  step_myDocker:
    docker:
      image: ubuntu:20.04
      
  step_myContainer:
    container:
      image: ubuntu:20.04
      cmds:
        - a
        - b
        - c</code></pre><p>Resolves to: (if <code>myStepSelection</code> is set to <code>Docker</code>)</p><pre><code class="yaml language-yaml">myStage:
  environments: [myEnv]
  myStep:
    docker:
      image: ubuntu:20.04

myMatrixStage:
  step_myDocker:
    docker:
      image: ubuntu:20.04
      
  step_myContainer:
    container:
      image: ubuntu:20.04
      cmds:
        - a
        - b
        - c</code></pre></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-02-25T11:26">2021-02-25</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link"><a href="exploration">exploration/</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><em>Parent directory zettel</em></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">.wharf-ci.yml</span><span class="ui basic label zettel-tag" title="Tag">root/exploration</span></div></nav><nav class="ui bottom attached icon compact inverted menu yellow" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/iver-wharf/wharf-notes/blob/master/./exploration/levels-of-variable-substitution.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.2" /></a></div></div></div></body></html>