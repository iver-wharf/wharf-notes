<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Orchestrating k8s build from cmd - Wharf architecture</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Iver" name="author" /><meta content="This originates from discussions in merge request on the cmd repo in our internal GitLab instance, !9." name="description" /><meta content="Orchestrating k8s build from cmd" property="og:title" /><meta content="Wharf architecture" property="og:site_name" /><meta content="article" property="og:type" /><meta content="orchestrating-k8s-build-from-cmd" property="neuron:zettel-id" /><meta content="orchestrating-k8s-build-from-cmd" property="neuron:zettel-slug" /><meta content="mr/cmd/9" property="neuron:zettel-tag" /><meta content="root/stub" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(251,189,8,0.1)}body nav.bottomPane{background-color:rgba(251,189,8,2.0e-2)}body div#footnotes{border-top-color:#fbbd08}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#fbbd08;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(251,189,8,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><!-- Mermaid  -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
window.addEventListener("load", mermaid.initialize({startOnLoad:true}))
</script>

<!-- Prism.js -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>

<!-- MathJax -->
<script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- end of head.html -->
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="stub">stub/</a></span></span></div></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Orchestrating k8s build from cmd</h1><blockquote><p>This originates from discussions in merge request on the cmd repo in our internal GitLab instance, !9.</p></blockquote><p>How do we in a clean and composable way run pods in k8s based on a <code>.wharf-ci.yml</code> file?</p><h2 id="issues">Issues</h2><ul><li><p>Kubernetes does not send an event of when a container has become “Ready”. Only when a container is “Ready” can you feed it with commands (equivalent to <code>kubectl exec</code>) and read logs off it (equivalent to <code>kubectl logs</code>)</p></li><li><p>Go channels does not support “fanout” strategies, making it difficult to work with for events.</p><ul><li>If the channel is closed -&gt; panic.</li><li>If no one is listening to the events -&gt; deadlock.</li><li>If multiple are listening to the same channel, only 1 gets the message.</li></ul></li><li><p>We need to keep the call stacks as best as we can so that panics and errors can be properly propagated. Splitting up into goroutines also means that we have to aggregate our results and errors when stuff goes wrong. Extra code that perhaps can be mitigated by not relying too heavily on goroutines for events and loops.</p></li></ul><h2 id="brainstorming">Brainstorming</h2><p>These are just ideas, nothing final.</p><h3 id="brainstorm-do-we-really-need-to-send-events">Brainstorm: Do we really need to send events</h3><p>We’re using events to get notified when all containers are ready. But would a <code>podClient.WaitForContainerReady</code> method be more appropriate?</p><p>Event-driven code is a nice strategy, but Go does not have great support for events with its lack of generics and lack of fan-out channels. We need a lot of “plumbing”/infrastructure set up to introduce this parigim that is arguably quite badly supported in Go.</p><p>This is explored more in-depth over at <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-19T10:35"><a href="events-in-go">Events in Go</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span>.</p><h3 id="brainstorm-how-do-we-access-repo-files-with-variable-substitution">Brainstorm: How do we access repo files with variable substitution</h3><p>Where does variable parsing come in the picture?</p><ul><li>Should that reside in it’s own package?</li><li>Stream the “var-sub” resources instead of storing everything in RAM?</li></ul><p>This deserves its own zettel to explore, but for now, let’s assume that the list of variable values have been calculated for us somehow and that there is some function that does raw variable substitution on strings for us; for the sake of argument, let’s call that the <code>util.SubstituteVariables</code> function.</p><h2 id="abstraction-layers">Abstraction layers</h2><blockquote><p>Going from higher level to lower level.</p></blockquote><ol><li><p>Orchestrate Wharf build</p><ul><li>In: Wharf build definition, step manager interface</li><li>Start stage</li><li>Wait until they’re finished</li><li>Start next list of parallel jobs</li><li>Run next stage, if there is another one queued</li></ul></li><li><p>Orchestrate Wharf stage</p><ul><li><p>In: List of steps to run in parallel, log watcher factory, step manager factory</p></li><li><p>Tasks:</p><ul><li>Create step managers from each step definition</li><li>Feed managers with log watcher factory</li><li>Tell all managers to start working</li><li>Wait until all are finished and removed</li></ul></li></ul></li><li><p>Step k8s pod manager : step manager interface</p><ul><li>In: Step definition</li><li>Tasks:<ul><li>Translate step definition to pod definition</li><li>Create pod</li><li>Listen to events<ul><li>Container ready: hook up log handlers</li><li>Container ready: run commands in it</li><li>Container shut down: close any log handlers</li></ul></li><li>Teardown: Delete pod via k8s API, if not already deleted</li></ul></li></ul></li><li><p>Easy pod facade</p><ul><li>In: Pod manifest (docker image, entrypoints, volumes)</li><li>Methods:<ul><li>creating pod</li><li>deleting pod</li><li>setup event watchers</li><li>run command in container</li><li>list containers and their statuses</li></ul></li><li>Tasks:<ul><li><p>Polyfill missing events, such as when container is “Ready”</p></li><li><p>Abstract away “init containers” vs “app containers” as the same, just have a boolean flag to distinguish them, but this boolean should not even need to be used.</p><blockquote><p>The only difference between an init container and regular containers are when they’re executed. Their names must even be unique across all containers, including init containers.</p><p>“The name of each app and init container in a Pod must be unique; a validation error is thrown for any container sharing a name with another.”<span data-nosnippet=""><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup></span></p></blockquote></li><li><p>Teardown: Delete pod via k8s API</p></li></ul></li></ul></li><li><p>Events sending</p><ul><li>Tasks:<ul><li>Allow registering of watchers</li><li>Allow sending messages</li><li>Messages are distributed to all watchers</li><li>Not listening -&gt; missing out on events</li></ul></li></ul></li></ol><h2 id="infrastructure">Infrastructure</h2><pre><code class="go language-go">package builder

type Logger {
    Logln(line string)
}

type LoggerFactory {
    NewLogger(source string) Logger
}

type consoleLoggerFactory struct {
    out io.Writer
}

type consoleLogger struct {
    out io.Writer
    source string
}

func (log consoleLogger) Logln(line string) {
    // maybe would be nice with some ANSI colors here
    fmt.Fprintf(log.out, &quot;%s: %s\n&quot;, c.source, line)
}</code></pre><h2 id="1-orchestrate-wharf-build">1. Orchestrate Wharf build</h2><pre><code class="go language-go">package builder

type StepResult struct {
    Name     string
    Type     string
    Success  bool
    Duration time.Duration
}

type StageResult struct {
    Name     string
    Success  bool
    Duration time.Duration
    Steps    []StepResult
}

type Result struct {
    Environment string
    Success     bool
    Duration    time.Duration
    Stages      []StageResult
}

type Builder interface {
    Build(def wharfyml.BuildDefinition) (Result, error)
}

type builder struct {
    run    StageRunner
    logFac LoggerFactory
}

func New(run StageRunner, logFac LoggerFactory) Builder {}

func (b Builder) Build(def wharfyml.BuildDefinition) (Result, error) {
    // This is just pseudo-code.
    stageResults := []
    buildTimer.Start()

    foreach stage
        res, err := stageRunner.Run(stage)
        if err
            return err
        stageResults.Add(res)

    buildTimer.Stop()
    return Result{stageResults}
}</code></pre><h2 id="2-orchestrate-wharf-stage">2. Orchestrate Wharf stage</h2><pre><code class="go language-go">package builder

type StageRunner interface {
    Run() (StageResult, error)
}

func NewStageRunner(run StepRunner, logFac LoggerFactory) StageRunner {}

func (r StepRunner) Run() (StageResult, error) {
    // This is just pseudo-code.
    stepResults = []
    stageTimer.Start()
    
    waitGroup.Add(len(steps))
    cancelCh := make(ch interface{})
    foreach step
        go r.runStep(step, waitGroup, cancelCh)
    waitGroup.Wait()
    
    stageTimer.Start()
    
    err := aggregateErrors()
    if err
        return err
    else
        return StageResult{stepResults}
}

func (r StageRunner) runStep(step wharfyaml.Step, wg sync.WaitGroup, cancelCh ch interface{}) {
    // This is just pseudo-code.
    defer handlePanic() // this should send panic through cancelCh
    
    res, err := r.stepRunner.Run(step)
    recordResult(res, err)
    wg.Done()
}</code></pre><h2 id="3-step-k8s-pod-manager--step-manager-interface">3. Step k8s pod manager : step manager interface</h2><pre><code class="go language-go">package builder

type StepRunner interface {
    Run() (StepResult, error)
}</code></pre><h2 id="4-easy-pod-facade">4. Easy pod facade</h2><pre><code class="go language-go">type PodFacade interface {
}</code></pre><h2 id="5-events-sending"><strike>5. Events sending</strike></h2><p>Event sending might not be that good of an option. I’ve created a separate page <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-19T10:35"><a href="events-in-go">Events in Go</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span> that explores this option. The solution is pretty bloated.</p><div id="footnotes"><ol><li id="fn1"><p>“Init Containers | Kubernetes” <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#detailed-behavior">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#detailed-behavior</a></p><a href="#fnref1">↩︎</a></li></ol></div></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-02-18T14:01">2021-02-18</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link"><a href="stub">stub/</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><em>Parent directory zettel</em></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">mr/cmd/9</span><span class="ui basic label zettel-tag" title="Tag">root/stub</span></div></nav><nav class="ui bottom attached icon compact inverted menu yellow" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/iver-wharf/wharf-notes/blob/master/./stub/orchestrating-k8s-build-from-cmd.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.3" /></a></div></div></div></body></html>