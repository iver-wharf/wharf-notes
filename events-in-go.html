<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Events in Go - Wharf architecture</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Iver" name="author" /><meta content="Go does not support events like how C# does. It turns out it’s actually quite tedious to add events to Go, especially due to the lack of generics in Go." name="description" /><meta content="Events in Go" property="og:title" /><meta content="Wharf architecture" property="og:site_name" /><meta content="article" property="og:type" /><meta content="events-in-go" property="neuron:zettel-id" /><meta content="events-in-go" property="neuron:zettel-slug" /><meta content="root/exploration" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(251,189,8,0.1)}body nav.bottomPane{background-color:rgba(251,189,8,2.0e-2)}body div#footnotes{border-top-color:#fbbd08}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#fbbd08;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(251,189,8,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
window.addEventListener("load", mermaid.initialize({startOnLoad:true}))
</script>
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2021-02-18T14:01"><a href="orchestrating-k8s-build-from-cmd">Orchestrating k8s build from cmd</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="stub">stub/</a></span></span></div></li></ul></li><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="exploration">exploration/</a></span></span></div></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Events in Go</h1><p>Go does not support events like how C# does. It turns out it’s actually quite tedious to add events to Go, especially due to the lack of generics in Go.</p><h2 id="the-issues-with-channels">The issues with channels</h2><p>Go channels does not support “fanout” strategies, making it difficult to work with for events.</p><ul><li>If the channel is closed -&gt; panic.</li><li>If no one is listening to the events -&gt; deadlock.</li><li>If multiple are listening to the same channel, only 1 gets the message.</li></ul><h2 id="the-issues-with-replicating-events">The issues with replicating events</h2><ul><li><p>Lack of generics in Go, so we have to rely on casting <code>interface{}</code> types such as:</p><pre><code class="go language-go">type Event struct {
    Type   string
    Object interface{}
}</code></pre></li></ul><h2 id="sample-implementation">Sample implementation</h2><p>Could use <a href="https://pkg.go.dev/k8s.io/apimachinery/pkg/watch">k8s.io/apimachinery/pkg/watch</a> here, though it’s not well documented and <a href="https://github.com/kubernetes/apimachinery">the repo on GitHub</a> advices against using it as they do not guarantee a stable API.</p><p>What you could do is just a really simple implementation instead:</p><pre><code class="go language-go">type ContainerState int
const (
    ContainerStarted ContainerState = iota
    ContainerReady
    ContainerStopped
)

type ContainerStateChange {
    OldState ContainerState
    State    ContainerState
    UID      string
    Name     string
}

type ContainerStateWatcher interface {
    ContainerStateChanged(event ContainerStateChange)
}

type PodEvents struct {
    containerState []ContainerStateWatcher
}

func (events *podEvents) OnContainerState(event ContainerStateChange) {
    for _, watcher := range events.containerState {
        watcher.ContainerStateChanged(event)
    }
}

func (events *podEvents) WatchContainerState(watcher ContainerStateWatcher) {
    events.containerState = append(events.containerState, watcher)
}</code></pre><p>Unregistering is the tricky part, as Go does not hash interfaces like C# does, nor do they support a nice and fast solution to just “remove a list item”, which is understandable.</p><h2 id="letting-listeners-unregister">Letting listeners unregister</h2><p>A more sophisticated solution that is able to unregister could be to store the watcher ID and use that in a map:</p><pre><code class="go language-go">type PodEvents struct {
    nextWatcherId int
    containerState *map[int]ContainerStateWatcher
}

func (events *podEvents) OnStateChanged(event ContainerStateChange) {
    if events.containerState == nil {
        return
    }
    for _, watcher := range events.containerState {
        watcher.ContainerStateChanged(event)
    }
}

type Unwatcher interface {
    Unwatch()
}

type containerStateUnregistrar struct {
    id        int
    podEvents *PodEvents
}

func (u containerStateUnwatcher) Unwatch() {
    delete(u.podEvents.containerState, u.id)
}

func (events *podEvents) WatchContainerState(watcher ContainerStateWatcher) Unwatcher {
    // throw in some sync.Mutex.Lock/Unlock here if we want to support concurrency
    events.nextWatcherId++
    id := events.nextWatcherId
    events[id] = watcher
    return containerStateUnwatcher { id, events }
}</code></pre><p>This also supports registering the same watcher instance multiple times and then receiving the same event multiple times.</p><p>Keep in mind, that this whole registering and unregistering code need to be duplicated for every event. As Go lacks generics, this is the way it has to be done, without traversing into the space of reflection, which I [Kalle] personally try to avoid at all times as it goes against the conventions and strengths that the language is trying to enforce.</p><h2 id="alternative-dont-use-events">Alternative: Don’t use events!</h2><p>For the above sample, something like this might be more appropriate:</p><pre><code class="go language-go">interface ContainerReadyWaiter {
    // Wait waits for the next container to be ready and returns true when it
    // has, or returns false if there are no more containers to wait for.
    Wait() bool
    // Container returns the container you have been Wait()&#39;ing for, or an error
    // if the waiting failed in some way. Returns (nil, nil) if Wait() has not
    // yet been called once.
    Container() (Container, error)
}</code></pre><p>Instead of listening for events to know when a container is ready, this interface could be used to traverse the containers and waiting until they are done before proceeding with the next, without even loosing the call stack such if you would’ve implemented this via goroutines.</p><p>Using it would involve something like:</p><pre><code class="go language-go">var waiter ContainerReadyWaiter

for waiter.Wait() {
    c, err := waiter.Container()
    if err != nil {
        return fmt.Errorf(&quot;wait to work with container: %w&quot;, err)
    }

    SetupLogStreaming(c)

    if cmds, ok := commandsPerContainer[c.Name]; ok {
        RunCommandsInContainer(c, cmds)
    }
}</code></pre><p>Solution is less flexible. Though it could arguably quite easily be changed to <code>ContainerStatusWaiter</code> to return whenever a status has been changed.</p></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-02-19T10:35">2021-02-19</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-18T14:01"><a href="orchestrating-k8s-build-from-cmd">Orchestrating k8s build from cmd</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><p>This is explored more in-depth over at <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-19T10:35"><a href="events-in-go">Events in Go</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span>.</p></div></li><li class="item"><div class="pandoc"><p>Event sending might not be that good of an option. I’ve created a separate page <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-19T10:35"><a href="events-in-go">Events in Go</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span> that explores this option. The solution is pretty bloated.</p></div></li></ul></li><li><span class="zettel-link-container folge"><span class="zettel-link"><a href="exploration">exploration/</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><em>Parent directory zettel</em></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">root/exploration</span></div></nav><nav class="ui bottom attached icon compact inverted menu yellow" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/iver-wharf/wharf-notes/blob/master/./exploration/events-in-go.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.33.0" /></a></div></div></div></body></html>