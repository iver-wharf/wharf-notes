<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Hide providers behind API - Wharf architecture</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Iver" name="author" /><meta content="Currently the user and web interface talks directly to the provider APIs." name="description" /><meta content="Hide providers behind API" property="og:title" /><meta content="Wharf architecture" property="og:site_name" /><meta content="article" property="og:type" /><meta content="hide-providers-behind-api" property="neuron:zettel-id" /><meta content="hide-providers-behind-api" property="neuron:zettel-slug" /><meta content="root/exploration" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(251,189,8,0.1)}body nav.bottomPane{background-color:rgba(251,189,8,2.0e-2)}body div#footnotes{border-top-color:#fbbd08}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#fbbd08;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(251,189,8,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><!-- Mermaid  -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
window.addEventListener("load", mermaid.initialize({startOnLoad:true}))
</script>

<!-- Prism.js -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>

<!-- MathJax -->
<script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- end of head.html -->
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2021-02-05T10:33"><a href="todo">Todo</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href=".">Wharf architecture</a></span></span></div></li></ul></li><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="exploration">exploration/</a></span></span></div></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Hide providers behind API</h1><p>Currently the user and web interface talks directly to the provider APIs.</p><p>This document explores how the providers should be redesigned, while the <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-15T10:14"><a href="wharf-provider-apis-as-plugins">Wharf provider APIs as plugins</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span> document explores how they should be plugged into a Wharf installation, compared to now.</p><h2 id="motive">Motive</h2><h3 id="benefits">Benefits</h3><ul><li><p>Generalizing import flow means we can deduplicate a lot of code from wharf-web, such as regarding auth flows.</p></li><li><p>Less code duplication overall between wharf-api, wharf-web and the wharf-provider-… projects as we can move most business logic into wharf-api.</p></li><li><p>Only 1 Swagger/OpenAPI specification, instead of wharf-api and each wharf-provider-… having their own.</p></li><li><p>Users of wharf-api only need to provide essential data, such as the ID of the project to import, instead of having to also feed in things like the URLs of the remote providers needed in a project refresh, as that data is already known in the DB. See <span class="zettel-link-container folge"><span class="zettel-link" title="2021-07-20"><a href="refreshing-project">Refreshing project</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span> for a concrete example.</p></li><li><p>Easier to extend the data flows and wharf-api&lt;-&gt;wharf-provider-… integration without building on further code rot.</p></li><li><p>Fewer entrypoints/attack surfaces to worry about security.</p></li></ul><h3 id="drawbacks">Drawbacks</h3><ul><li><p>Take a lot of time to design and develop.</p></li><li><p>Makes it harder to have custom implementations and endpoint behaviors per provider.</p></li><li><p>Forces the wharf-api &lt;-&gt; wharf-provider API layers to be highly rigid. Introducing changes will need updates in multiple repos and lots of backward compatibilities. Though that’s the case in today’s solution as well.</p></li></ul><h2 id="redesign">Redesign</h2><p>To better the situation, a redesign is in order.</p><h2 id="considerations-for-redesign">Considerations for redesign</h2><ul><li><p>Wharf-api must via dependency-inversion talk to a predefined provider API “standard” that the wharf-provider-github, among others, must comply with, so that we avoid any circular dependencies.</p></li><li><p>Stay with REST so that the provider APIs can still use the <a href="https://github.com/iver-wharf/wharf-api-client-go">wharf-api-client-go</a> library for when the providers want to initiate communication, such as when they want to start a new build because of a newly added PR.</p></li></ul><h2 id="ideas-for-redesign">Ideas for redesign</h2><ul><li><p>Import procedure should be completely revamped. Instead of providing credentials on each import, it should instead be:</p><ul><li><p>Set up credentials beforehand</p></li><li><p>Import project using one of the existing credentials (for a given provider)</p></li><li><p>Provider API should provide a list of project candidates to import, and wharf-api should mark those that have already been imported with a boolean flag.</p></li></ul></li><li><p>Leave the data-collection over to the wharf-api. The user should not have to provide lots of data just because we’re lazy when the wharf-api could easily figure out all the data via the DB.</p></li><li><p>Regen access tokens for every request to the wharf-provider-…</p></li><li><p><strike>Let each provider get their own DB schema to store the tokens for themselves. They would need something like a 1-N mapping from credentials to Wharf project IDs.</strike></p><blockquote><p>Do we really want to add dependency on the DB from the providers?</p><p>If wharf-api stored the credentials in the DB serialized as JSON then the providers would control the format, and the DB remains hidden behind the wharf-api.</p><p>Letting more services depend on the DB means more places to worry about sustaining connection, DB migrations, resolving connection issues, switching which DB to use, etc.</p></blockquote></li></ul><h2 id="proposed-provider-endpoints">Proposed provider endpoints</h2><p>Base URL is subject for change, or even variable on a per-provider basis.</p><ul><li><p>Fetching data from known project.</p></li><li><p>Fetching list of candidate projects to import.</p></li><li><p>Heartbeat to verify that the provider is still available. To be used in metrics and possibly notify the user in wharf-web when picking a provider to import via.</p></li><li><p>Get Git URL to be used in builds. Cannot be a static field in the database as some integrations, such as GitHub Apps, require usage of tokens with 1h lifetime.</p></li><li><p>Wildcard endpoint to be forwarded, such as for authentication or webhooks. <em>Unsure about this though, as they will not be documented.</em></p></li></ul></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-07-20">2021-07-20</time></div></div></article><nav class="ui attached segment dirfolge"><div class="ui list listing"><div class="item listing-item"><i class="folder icon"></i><div class="content"><div class="description"><span class="zettel-link-container"><span class="zettel-link" title="Zettel: exploration/"><a href="exploration"><i class="level up alternate icon"></i></a></span></span></div></div></div><div class="item listing-item"><i class="file outline icon"></i><div class="content"><div class="description"><span class="zettel-link-container folge"><span class="zettel-link" title="2021-07-20"><a href="authenticating-providers">Authenticating providers</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span></div></div></div><div class="item listing-item"><i class="file outline icon"></i><div class="content"><div class="description"><span class="zettel-link-container folge"><span class="zettel-link" title="2021-07-20"><a href="refreshing-project">Refreshing project</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span></div></div></div></div><a href="https://neuron.zettel.page/dirtree" title="What is this section about?"><i class="question circle outline icon"></i></a></nav><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-05T10:33"><a href="todo">Todo</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><p>Turn providers into plugins, even for the frontend. (explored in <span class="zettel-link-container folge"><span class="zettel-link" title="2021-02-15T10:14"><a href="wharf-provider-apis-as-plugins">Wharf provider APIs as plugins</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span> &amp; <span class="zettel-link-container folge"><span class="zettel-link" title="2021-07-20"><a href="hide-providers-behind-api">Hide providers behind API</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span>)</p></div></li></ul></li><li><span class="zettel-link-container folge"><span class="zettel-link"><a href="exploration">exploration/</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><em>Parent directory zettel</em></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">root/exploration</span></div></nav><nav class="ui bottom attached icon compact inverted menu yellow" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/iver-wharf/wharf-notes/blob/master/./exploration/hide-providers-behind-api.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.3" /></a></div></div></div></body></html>